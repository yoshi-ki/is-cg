<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title id="title">texture synthesys</title>
<script type="text/javascript">
var canvas = document.createElement("canvas");
var canvas2 = document.createElement("canvas");
var canvas3 = document.createElement("canvas");
var context = canvas.getContext("2d");
var context2 = canvas2.getContext("2d");
var context3 = canvas3.getContext("2d");

var texture_num = 2;
var overlap = 4;

function synthesize(width, height, original, synthesized) {
    //まず、randomに選び、textureを作成する
    var subtexture = 4 //もとのtextureを4つに分けた大きさで作成
    for (var i = 0; i < texture_num * subtexture; i++){
      for (var j = 0; j < texture_num * subtexture; j++){
        //座標(start_x,start_y)を始めとした16*16がこのiterationでは代入される
        var start_x = i * (width / subtexture);
        var start_y = j * (height / subtexture);
        var idx0 = (start_x + start_y * width * texture_num);

        // randomにcopyもとの座標を選ぶ
        // 0 - 47の範囲で発生させる
        var rx = Math.floor(Math.random() * (width - (width/subtexture)) );
        var ry = Math.floor(Math.random() * (height - (height/subtexture)) );
        var idr0 = rx + ry * width;

        for (var k = 0; k < (height/subtexture); k++){
          for (var l = 0; l < (width/subtexture); l++){
            var idx = idx0 + (l + k * width * texture_num);
            var idr = idr0 + (l + k * width);
            synthesized[4 * idx    ] = original[4 * idr    ];
            synthesized[4 * idx + 1] = original[4 * idr + 1];
            synthesized[4 * idx + 2] = original[4 * idr + 2];
            synthesized[4 * idx + 3] = 255;
          }
        }

      }
    }
};

function synthesize2(width, height, original, synthesized) {
    //まず、randomに選び、textureを作成する
    var subtexture = 4 //もとのtextureを4つに分けた大きさで作成
    for (var i = 0; i < texture_num * subtexture; i++){
      for (var j = 0; j < texture_num * subtexture; j++){
        //座標(start_x,start_y)を始めとした16*16がこのiterationでは代入される
        var start_x = i * (width / subtexture);
        var start_y = j * (height / subtexture);
        var idx0 = (start_x + start_y * width * texture_num);

        // randomにcopyもとの座標を選ぶ
        // 5 - 47の範囲で発生させる
        var flag;
        do{
            flag = true;
            //乱数チェックと
            var rx = Math.floor(Math.random() * (width - (width/subtexture) - 5) + 5);
            var ry = Math.floor(Math.random() * (height - (height/subtexture) - 5) + 5);
            var idr0 = rx + ry * width;

            //横方向のチェック
            if(i != 0){
            for (var k = 0; k < (height/subtexture); k++){
                for (var l = 0; l < (width/subtexture); l++){
                    //neighbor判定を行う
                    var idx = idx0 + (l + k * width * texture_num);
                    var idr = idr0 + (l + k * width);
                    synthesized[4 * idx    ] = original[4 * idr    ];
                    synthesized[4 * idx + 1] = original[4 * idr + 1];
                    synthesized[4 * idx + 2] = original[4 * idr + 2];
                    synthesized[4 * idx + 3] = 255;
                }
            }
            }

            //上方向のチェック
            if(j != 0){


            }
        }
        while(flag);

        for (var k = 0; k < (height/subtexture); k++){
          for (var l = 0; l < (width/subtexture); l++){
            var idx = idx0 + (l + k * width * texture_num);
            var idr = idr0 + (l + k * width);
            synthesized[4 * idx    ] = original[4 * idr    ];
            synthesized[4 * idx + 1] = original[4 * idr + 1];
            synthesized[4 * idx + 2] = original[4 * idr + 2];
            synthesized[4 * idx + 3] = 255;
          }
        }

      }
    }
};


function init() {
    document.getElementById("img_original").onload = function(){
        canvas.width  = this.width;
        canvas.height = this.height;
        canvas2.width  = this.width * texture_num;
        canvas2.height = this.height * texture_num;
        canvas3.width  = this.width * texture_num;
        canvas3.height = this.height * texture_num;
        document.getElementById("img_random_result"  ).width  = texture_num * this.width;
        document.getElementById("img_random_result"  ).height = texture_num * this.height;
        document.getElementById("img_neighbor_result"  ).width  = texture_num * this.width;
        document.getElementById("img_neighbor_result"  ).height = texture_num * this.height;
    };
    document.getElementById("input_file_original").onchange = function(evt) {
        var reader = new FileReader();
        reader.readAsDataURL(evt.target.files[0]);
        reader.onload = function(){
            document.getElementById("img_original").src = this.result;
        };
    };
    document.getElementById("btn_do_synthesize").onclick = function() {
        // parameterの調整
        var width = canvas.width;
        var height = canvas.height;
        // read original
        context.drawImage(document.getElementById("img_original"), 0, 0);
        var original = context.getImageData(0, 0, width, height);


        // do synthesizing
        var synthesized = context2.createImageData(texture_num * width, texture_num * height);
        synthesize(width, height, original.data, synthesized.data);
        context2.putImageData(synthesized, 0, 0);
        document.getElementById("img_random_result").src = canvas2.toDataURL();




        var synthesized2 = context3.createImageData(texture_num * width, texture_num * height);
        synthesize2(width,height,original.data,synthesized2.data);
        context3.putImageData(synthesized2,0,0);
        document.getElementById("img_neighbor_result").src = canvas3.toDataURL();
    };
    document.getElementById("img_original").src = "https://cdn.glitch.com/f065ea62-a8fe-47cd-b5b2-9b44e13dc84d%2Ftexture-ss.png?v=1596026069143";
};
</script>
</head>
<body onload="init()">
  <h2><a target="_blank" href="http://research.nii.ac.jp/~takayama/teaching/utokyo-iscg-2020/"><script type="text/javascript">document.write(document.getElementById("title").innerHTML);</script></a></h2>
  <table><tr valign="top">
    <td align="center"><img id="img_original" crossorigin="anonymous"><br>Original</td>
    <td align="center"><img id="img_random_result"><br>random result</td>
    <td align="center"><img id="img_neighbor_result"><br>neighbor result</td>
  </tr></table>
  <ul>
    <li>Load Image: <input type="file" id="input_file_original" accept="image/*"></li>

    <li><button id="btn_do_synthesize">synthesize</button></li>
  </ul>

  <div class="glitchButton" style="position:fixed;top:20px;right:20px;"></div>
  <script src="https://button.glitch.me/button.js"></script>
</body>
</html>
